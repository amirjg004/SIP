var xhr,progressInterval,progressTimeout,retryDeviceTimeout,scriptsPath="https://scr.siptv.app/scripts/",commonPath="https://scr.siptv.app/common/",maxTimeout=10,timeoutCounter=0,retryCount=0,plistUpdate=!0,blob=new Blob([]);function timeoutNotify(){++timeoutCounter==maxTimeout&&($("#retryMessage").hide(),$("#connectMessage").show(),keyEvents(),mouseEvents()),$("#tPassed").html("connection timeout: "+timeoutCounter+"s")}function timeoutReset(){timeoutCounter=0,clearInterval(progressInterval),progressInterval=setInterval(timeoutNotify,1e3),$("#connectMessage").hide()}function setAjaxTimeout(){sessionStorage.setItem("ajaxTimeout","on")}function keyEvents(){$(document).unbind("keydown keyup").keydown(function(e){switch(e.which){case VK_ENTER:setAjaxTimeout(),xhr.abort();break;case VK_STOP:case VK_S:window.location.reload(!0)}})}function retryKeyEvents(){$(document).unbind("keydown keyup").keydown(function(e){switch(e.which){case VK_ENTER:backToHome();break;case VK_STOP:case VK_S:window.location.reload(!0)}})}function mouseEvents(){$("#tMessage #okButton").unbind("click").click(function(){setAjaxTimeout(),xhr.abort()})}function retryMouseEvents(){$("#tMessage #okButton").unbind("click").click(function(){backToHome()})}function retryDeviceInfo(){retryCount>4&&(retryKeyEvents(),retryMouseEvents(),$("#connectMessage").hide(),$("#retryMessage").show(),$("#idPassed").html(retryCount+"s")),getDeviceInfo()}function getDeviceInfo(){sessionStorage.removeItem("ajaxTimeout"),timeoutReset(),localStorage_getItem("extUrl")?extURL=localStorage_getItem("extUrl"):extURL="",webOSDev.LGUDID({onSuccess:function(e){var t=e.id,a=formatMac(t);webOS.service.request("luna://com.webos.service.tv.systemproperty",{method:"getSystemInfo",parameters:{keys:["modelName","serialNumber"]},onSuccess:function(e){var o=e.serialNumber,r=e.modelName;tvInfo={mac:a,serial:o,udid:t,manuf:"LGE",model:r,extUrl:extURL},getUserData()},onFailure:function(e){}})},onFailure:function(e){clearTimeout(retryDeviceTimeout),retryDeviceTimeout=setTimeout(retryDeviceInfo,1e3),retryCount++}})}function getUserData(){xhr=$.post(commonPath+"go_lg_webos.php?ver="+appVersion,tvInfo,function(e){timeoutReset();try{userData=JSON.parse(e)}catch(e){console.log(e)}if("1"==userData.online)sessionStorage.setItem("userData",e),window.location="online.html";else if(checkPlistRefresh(),"0"==userData.plistUpdate?plistUpdate=!1:"2"==userData.plistUpdate&&(plistUpdate=!0),plistUpdate)if(userData.extUrl){try{urlArray=JSON.parse(userData.extUrl)}catch(e){console.log(e)}urls=urlArray.length,plistArray={},fetchPlist(0)}else setLocalStorage();else setLocalStorage()}).fail(function(){onConnectFail()})}function fetchPlist(e){sessionStorage.getItem("antiCache")?urlCache=!1:urlCache=!0,e<urls?($("#urlNr").html("URL Nr. "+(e+1)),urlCache?url=urlArray[e]:url=urlArray[e]+"?_="+(new Date).getTime(),(xhr=new XMLHttpRequest).open("GET",url,!0),xhr.responseType="blob",xhr.send(),xhr.onload=function(t){xhr.status>=400&&(blob=new Blob([blob,"\n#EXTPLIST\n","group,URL Nr. "+(e+1)+" Error!\next,Check playlist Nr. "+(e+1)+" URL!,Check_your_playlist_URL"]),console.log("Fail! Nr. "+(e+1)),fetchPlist(e+1))},xhr.onreadystatechange=function(){4===xhr.readyState&&200===xhr.status&&(timeoutReset(),blob=new Blob([blob,"\n#EXTPLIST\n",xhr.response]),console.log("Success! "+(e+1)),fetchPlist(e+1))},xhr.onerror=xhr.onabort=function(t){blob=new Blob([blob,"\n#EXTPLIST\n","group,URL Nr. "+(e+1)+" Error!\next,Check playlist Nr. "+(e+1)+" URL!,Check_your_playlist_URL"]),console.log("Fail! Nr. "+(e+1)),fetchPlist(e+1)}):(timeoutReset(),$("#urlNr").html("Server upload"),postData=new Blob([JSON.stringify({user:userData.user,serial:userData.serial,keep:userData.private,urls:urlArray}),blob]),blob=null,xhr=$.ajax({type:"post",url:scriptsPath+"process_upload_blob.php",data:postData,cache:!1,processData:!1,contentType:"application/octet-stream"}).done(function(e){timeoutReset(),updatePlistTime(),setLocalStorage()}).fail(function(){onConnectFail()}))}function setLocalStorage(){localStorage_setItem("myUzer",userData.user),localStorage_setItem("ytToken",userData.ytToken),localStorage_setItem("vkToken",userData.vkToken),localStorage_setItem("secret",userData.secret),localStorage_setItem("newVersion",userData.newVersion),localStorage_setItem("appExpiration",userData.appExpiration),localStorage_setItem("epgId",userData.epgId),userData.macLock&&0!=userData.macLock?localStorage_setItem("macLock",userData.macLock):localStorage_removeItem("macLock"),localStorage_setItem("sampleRate",userData.sampleRate),localStorage_setItem("online",userData.online),1==userData.private?(localStorage_setItem("privateList",1),localStorage_removeItem("chListUpdate")):2==userData.private?(localStorage_setItem("privateList",2),plistUpdate?localStorage_setItem("chListUpdate",1):localStorage_removeItem("chListUpdate"),userData.extUrl||localStorage_removeItem("extUrl")):(localStorage_removeItem("privateList"),localStorage_removeItem("chListUpdate")),userData.extUrl&&localStorage_setItem("extUrl",userData.extUrl),userData.rodina&&localStorage_setItem("rodina_sid",userData.rodina),"default-lg"==userData.user?window.location="payment.html":"default-pw"==userData.user?window.location="paymentwall.html":"off"==localStorage_getItem("initPortal")?window.location="fullscreen.html":window.location="channels.html"}function onConnectFail(){localStorage_getItem("myUzer")&&localStorage_getItem("chData")||(localStorage_setItem("myUzer","nolist-lg"),localStorage_setItem("currentGroup","All"),localStorage_setItem("currentChannel",1)),window.location="channels.html"}function checkPlistRefresh(){getPlistRefresh(),checkPlistTime();var e=(new Date).getTime()/1e3;plistUpdate=!(0!=plistRefresh&&0!=lastUpdate&&!sessionStorage.getItem("plistUpdate"))||2==plistRefresh&&e-lastUpdate>3600||3==plistRefresh&&e-lastUpdate>10800||4==plistRefresh&&e-lastUpdate>21600||5==plistRefresh&&e-lastUpdate>43200||6==plistRefresh&&e-lastUpdate>86400||7==plistRefresh&&e-lastUpdate>259200||8==plistRefresh&&e-lastUpdate>604800,sessionStorage.removeItem("plistUpdate")}function updatePlistTime(){var e=(new Date).getTime()/1e3;localStorage_setItem("plistTime",e)}function checkPlistTime(){localStorage_getItem("plistTime")&&!isNaN(localStorage_getItem("plistTime"))?lastUpdate=Number(localStorage_getItem("plistTime")):lastUpdate=0}function onMouseActive(){}function onMouseInactive(){}window.onload=getDeviceInfo;